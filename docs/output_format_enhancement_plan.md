# 出力フォーマット拡張機能計画書

## 概要

短期滞在手術等基本料３判定プログラムの出力フォーマットを拡張し、以下の機能を追加します：

1. 出力データのフォーマットに「短手３対象症例」と「理由」の列を追加
2. 設定で短手３対象症例のみを出力するか、全症例を出力するかを選択可能にする
3. 短手３対象症例の場合は「Yes」、そうでない場合は「No」を表示
4. 理由欄には対象症例の場合は実施された対象手術名を、非対象症例の場合は非該当理由を表示

## 実装計画

### 1. 型定義の拡張

`src/core/common/types.ts` に以下の変更を加えます：

- `CaseData` インターフェースに `isEligible` と `reason` フィールドを追加
- 出力設定用の新しい型 `OutputSettings` を追加

### 2. 定数の更新

`src/core/common/constants.ts` に以下の変更を加えます：

- `DEFAULT_RESULT_HEADER` を更新して新しい列を含める
- 対象手術等のコードと名称のマッピングを追加
- 非該当理由のメッセージ定数を追加

### 3. 評価ロジックの拡張

`src/core/common/evaluator.ts` に以下の変更を加えます：

- `evaluateCases` 関数を拡張して、各症例の適格性と理由を判定・設定
- `formatResults` 関数を更新して、新しいフォーマットと設定に対応
- 全症例出力モードに対応するロジックを追加

### 4. UI の拡張

`public/index.html` に以下の変更を加えます：

- 出力設定用のラジオボタンまたはチェックボックスを追加
- 設定セクションのスタイルを調整

`public/css/styles.css` に以下の変更を加えます：

- 新しい UI 要素のスタイルを追加

`public/js/main.js` に以下の変更を加えます：

- 設定値の取得と保存のロジックを追加
- 実行ボタン押下時に設定を評価ロジックに渡す処理を追加

### 5. テストの更新

`test/jest/unit/evaluator.test.ts` に以下の変更を加えます：

- 拡張された評価ロジックのテストケースを追加
- 新しいフォーマット出力のテストを追加
- 全症例出力モードのテストを追加

## 実装詳細

### 短手３対象症例の判定と理由の設定

1. 短手３対象症例の場合：
   - `isEligible` を `true` に設定
   - `reason` に実施された対象手術の名称を設定

2. 短手３対象外の症例の場合：
   - `isEligible` を `false` に設定
   - `reason` に非該当理由を設定
     - 退院日未確定: "退院日未確定"
     - 対象手術等なし: "対象手術等なし"
     - 入院期間超過: "入院期間が６日以上"
     - 複数対象手術: "対象手術等を２以上実施"
     - 他の手術あり: "対象手術等以外の手術あり"
     - 特定加算あり: "内視鏡的大腸ポリープ術に特定加算あり"

### 出力設定の実装

1. UI に「出力設定」セクションを追加
   - ラジオボタン: "短手３対象症例のみ" / "全症例"
   - デフォルト: "短手３対象症例のみ"

2. 設定に基づいて出力する症例をフィルタリング
   - "短手３対象症例のみ": `isEligible === true` の症例のみ
   - "全症例": すべての症例（`isEligible` の値に関わらず）

## 実装スケジュール

1. 型定義と定数の更新
2. 評価ロジックの拡張
3. UI の拡張
4. テストの更新と実行
5. 動作確認とバグ修正

## 注意点

- 既存の機能を壊さないよう、慎重に実装する
- 新しい機能はオプションとして提供し、既存の動作をデフォルトとする
- UI の変更は最小限に抑え、ユーザーにとって直感的な操作を維持する
- 全症例出力モードでは、データ量が増加するため、パフォーマンスに注意する 