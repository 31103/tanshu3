# リファクタリング計画 (2025-03-29)

## 1. 目的

コードベース全体の品質向上、保守性向上、テストカバレッジ向上を目指す。
重点項目: 不要要素の整理、テスト充実、エラーハンドリング強化、コードコメント強化。

## 2. 作業ブランチ

`feature/refactoring`

## 3. 作業項目詳細

### 3.1. 不要な要素の整理

- **対象:**
  - `test/run-tests.js`
  - `test/accessibility/` ディレクトリ全体
  - `test/browser-compatibility/` ディレクトリ全体
  - `src/types/types.d.ts`
  - プロジェクト全体の未使用コード (関数、変数、インポートなど)
  - 古い `// TODO:` コメントや不要なコメント
- **作業内容:**
  - `test/` 以下のレガシーなテストファイル/ディレクトリの内容を確認する。Jest でカバーされている、または現在価値がないと判断される場合は削除する。有用なテストロジックがあれば、Jest への移行対象とする (項目 3.2 参照)。
  - `src/types/types.d.ts` の内容を確認する。グローバルな型定義が不要であれば削除する。特定のモジュールに属する型であれば、そのモジュールファイル内に移動する。
  - ESLint (`no-unused-vars` など) や手動レビューにより、未使用のコードやコメントを特定し、削除する。 **(一部確認中)**
- **ステータス:** **完了 (一部確認中)**

### 3.2. テストの充実

- **対象:**
  - `src/core/common/utils.ts`
  - `src/core/common/parsers.ts`
  - `src/core/validator.ts`
  - `src/core/file-processor.ts`
  - `src/ui/components/file-manager.ts`
  - `src/ui/components/notification.ts`
  - `src/ui/components/result-viewer.ts`
  - (項目 3.1 で移行対象となったレガシーテスト)
- **作業内容:**
  - `npm run test:coverage` を実行し、カバレッジレポートを確認する。
  - カバレッジが低いコアロジック (`utils.ts`, `parsers.ts` など) を中心に、テストケースを追加・改善し、カバレッジ向上を目指す (目標: 各ファイル 85% 以上)。
  - Jest と JSDOM を利用し、UI コンポーネント (`src/ui/components/`) の基本的なレンダリング確認、要素存在確認、イベントハンドラ呼び出し確認などのテストを作成する。 **(Jest 環境設定修正、`result-viewer.test.ts` の `URL.createObjectURL` モック追加、アサーション修正。残エラーあり)**
  - 項目 3.1 で移行が必要と判断されたレガシーテストがあれば、Jest 形式に書き換える。
- **ステータス:** **作業中 (parsers.ts テスト強化、UIテスト環境整備・コード修正中: `result-viewer.test.ts` 一部修正、`notification.test.ts`, `file-manager.test.ts` 未修正)**

### 3.3. エラーハンドリング強化

- **対象:**
  - `src/browser/main.ts` (イベントハンドラ内の処理呼び出し部分)
  - `src/core/file-processor.ts` (ファイル読み込み、検証、解析、評価の各ステップ)
  - `src/core/validator.ts` (各検証ルール)
  - `src/core/common/parsers.ts` (ファイル解析処理)
  - `src/ui/components/notification.ts` (エラーメッセージ表示部分)
- **作業内容:**
  - 各処理ステップで発生しうるエラー（ファイル読み込み失敗、不正フォーマット、予期せぬ例外など）を想定し、`try...catch` ブロックを適切に配置する。
  - エラー発生時、アプリケーションが停止せず、ユーザーにエラーが発生したことを明確に伝えるようにする。
  - `catch` ブロックでエラーオブジェクトを捕捉し、エラーの種類や発生箇所に応じて、より具体的で分かりやすい日本語のエラーメッセージを生成するロジックを追加・修正する。
  - 生成したエラーメッセージを `Notification` コンポーネントに渡し、ユーザーに表示させる。メッセージ例: 「ファイル読み込みエラー: ファイルが見つかりません。」、「解析エラー: 15行目の日付形式が不正です (YYYYMMDD 形式で入力してください)。」、「予期せぬエラーが発生しました: [エラー詳細]」。
- **ステータス:** **一部着手 (UI エラーハンドリング改善)**

### 3.4. コードコメント修正・強化

- **対象:** `src/` ディレクトリ以下のすべての `.ts` ファイル
- **作業内容:**
  - `.clinerules` に従い、すべてのファイル、クラス、関数、メソッド、および複雑なロジックブロックに対して、その目的、動作、引数、戻り値、前提条件などを説明する JSDoc 形式の日本語コメントを追加・修正する。
  - 既存のコメントが古くなっていたり、不十分だったりする場合は、最新のコードに合わせて更新する。
  - 特に、`evaluator.ts` の判定ロジック、`file-processor.ts` の月またぎ処理など、コアとなる複雑な部分のコメントを重点的にレビュー・強化する。
- **ステータス:** **作業中 (関連ファイル修正に伴い更新)**

### 3.5. Memory Bank 更新

- **対象:**
  - `memory-bank/activeContext.md`
  - `memory-bank/progress.md`
  - `memory-bank/systemPatterns.md` (必要に応じて)
  - `memory-bank/techContext.md` (必要に応じて)
- **作業内容:**
  - 上記 3.1 から 3.4 のリファクタリング作業による変更点（削除されたファイル、変更されたロジック、強化されたテスト体制、改善されたエラーハンドリングなど）を各 Memory Bank ファイルに反映させる。
  - `activeContext.md` にリファクタリング作業の完了と次のステップを記述する。
  - `progress.md` の「完了した機能」「残りの作業」「既知の問題」などを更新する。
- **ステータス:** **未着手**

## 4. 作業手順（実績と予定）

1.  Feature ブランチ作成 (`git checkout -b feature/refactoring`) - **完了**
2.  この計画ドキュメント (`docs/refactoring_plan.md`) を作成・コミット (`764e193`) - **完了**
3.  不要な要素の整理 (3.1) を実施・コミット (`c586776`) - **完了**
4.  テストの充実 (3.2) を実施 - **作業中 (`result-viewer.test.ts` 一部修正、未コミット)**
5.  エラーハンドリング強化 (3.3) を実施 - **一部着手 (UI エラーハンドリング改善、未コミット)**
6.  コードコメント修正・強化 (3.4) を実施 - **作業中 (関連ファイル修正に伴い更新、未コミット)**
7.  Memory Bank 更新 (3.5) を実施 - **作業中 (この更新で実施)**
8.  全体の動作確認、リントチェック (`npm run check-all`) - **未着手**
9.  Pull Request 作成 (main ブランチへ) - **未着手**
