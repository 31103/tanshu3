# 短期滞在手術等基本料３判定プログラム

## 概要

このプログラムは、入院EF統合ファイルを読み込み、短期滞在手術等基本料３（以下、「短手３」という。）に該当する症例を判別するためのツールです。

## 機能

- 入院EF統合ファイル（タブ区切りテキスト形式）の読み込み
- 複数ファイルの一括処理（連続した複数月のファイルに対応）
- 短手３該当症例の判定
- 結果のタブ区切りテキストファイル出力
- 処理結果の統計情報表示

## インストールとセットアップ

### 必要条件
- Windows PC（Windows 10以上推奨）
- モダンブラウザ（Google Chrome、Microsoft Edge、Firefox など）
- Node.js（開発時のみ、v14以上推奨）

### セットアップ手順
1. このリポジトリをクローンまたはダウンロードします
   ```powershell
   git clone https://github.com/username/tanshu3.git
   cd tanshu3
   ```

2. 必要なパッケージをインストールします
   ```powershell
   npm install
   ```

3. TypeScriptファイルをコンパイルします
   ```powershell
   npm run build
   ```

## 使用方法

1. `index.html` をブラウザで開きます
2. 「ファイルを選択」ボタンをクリックし、処理対象の入院EF統合ファイルを選択します（複数選択可能）
3. 「実行」ボタンをクリックして処理を開始します
4. 処理が完了すると、短手３該当症例の一覧が表示されます
5. 「結果をダウンロード」ボタンをクリックすると、結果をテキストファイルとして保存できます

## ファイル構成

### ソースファイル
- `index.html` - ユーザーインターフェース
- `common.ts` - 共通のビジネスロジック（Node.js環境用、ESモジュール形式）
- `common.browser.ts` - 共通のビジネスロジック（ブラウザ環境用、グローバル変数形式）
- `main.ts` - ブラウザ環境での実行に関する処理
- `test.ts` - 自動テスト実行用スクリプト
- `types.d.ts` - 型定義ファイル

### ビルド後のファイル
- `dist/common.js` - コンパイル後の共通ロジック（Node.js環境用）
- `dist/common.browser.js` - コンパイル後の共通ロジック（ブラウザ環境用）
- `dist/main.js` - コンパイル後のUI処理
- `dist/test.js` - コンパイル後のテストスクリプト

### ドキュメント
- `docs/project_overview.md` - プロジェクト概要と仕様書
- `docs/入院EF統合ファイルについて.md` - 入院EF統合ファイルの仕様説明
- `docs/短期滞在手術等基本料３について.md` - 短期滞在手術等基本料３の説明

### その他
- `test_data/` - テスト用データファイル
- `package.json` - プロジェクト設定とスクリプト
- `tsconfig.json` - TypeScriptコンパイラ設定

## 技術的な詳細

### 短手３該当条件

短期滞在手術等基本料３に該当する条件は以下の通りです：

1. 入院中に対象手術等（特定の診療行為コード）のうちいずれか一つを行っている
2. 入院期間が5日以内である
3. 入院期間中に対象手術等を2以上実施していない
4. 入院期間中に対象手術等に加えて、手術を実施していない
5. 内視鏡的大腸ポリープ・粘膜切除術を行う場合、特定の加算を算定していない

詳細は `docs/短期滞在手術等基本料３について.md` を参照してください。

### 入院EF統合ファイル

入院EF統合ファイルは、タブ区切りテキスト形式のファイルで、月ごとに作成されます。
このプログラムでは、複数月のファイルを一括処理し、同一患者の情報を統合して判定します。

詳細は `docs/入院EF統合ファイルについて.md` を参照してください。

### 処理フロー

1. 入院EF統合ファイルの読み込み
2. ファイル内容の解析と症例データの抽出
3. 複数ファイルからの症例データの統合
4. 短手３該当条件に基づく判定
5. 結果のフォーマットと出力

## テスト方法

テストデータを使用して、プログラムの動作を検証することができます：

```powershell
npm run build  # TypeScriptファイルをコンパイル
npm run test   # テストを実行
```

テストが成功すると「全テストが成功しました！」と表示されます。

### テスト用データの準備

テスト用データは `test_data` ディレクトリに配置されています。独自のテストデータを使用する場合は、同じ形式でファイルを準備し、`test.ts` を適宜修正してください。

## 開発とメンテナンス

### コード修正ガイド
- ビジネスロジックの変更が必要な場合は `common.ts` を修正します
- UI関連の変更が必要な場合は `index.html` と `main.ts` を修正します
- テスト関連の変更が必要な場合は `test.ts` を修正します
- 型定義の変更が必要な場合は `types.d.ts` を修正します
- 新しい機能を追加する場合は、適切なファイルに実装し、必要に応じてテストを追加します
- コード変更後は `npm run build` でTypeScriptをコンパイルします

### 開発フロー

1. TypeScriptファイル（`.ts`）を編集
2. `npm run build` コマンドでJavaScriptにコンパイル
3. ブラウザで `index.html` を開いて動作確認

### 環境別の実装について

- **Node.js環境（テスト実行時）**: ESモジュールを使用し、`common.ts`から関数をインポート
- **ブラウザ環境（ユーザー実行時）**: ローカルファイル（file://プロトコル）でのCORSポリシーに対応するため、`common.browser.ts`を使用してグローバル変数として関数を公開
- この二重実装により、テスト環境と実行環境の両方で正常に動作することを保証

## トラブルシューティング

### よくある問題と解決方法

- **Q: ファイルを選択しても何も起きない**
  - A: ブラウザの設定でJavaScriptが有効になっていることを確認してください。また、コンソールエラーがないか確認してください。

- **Q: 処理に時間がかかる**
  - A: 大量のデータを処理する場合は時間がかかることがあります。処理中はブラウザを閉じないようにしてください。

- **Q: 出力結果がダウンロードできない**
  - A: ブラウザのダウンロード設定を確認してください。また、別のブラウザで試してみてください。

### サポート

問題が解決しない場合は、以下の情報を添えて開発者に連絡してください：
- 使用しているブラウザとバージョン
- 発生した問題の詳細
- エラーメッセージ（ある場合）
- 処理対象ファイルのサイズと件数

## ライセンス

本プロジェクトは内部利用を目的としており、一般公開用のライセンスは付与されていません。
無断での複製・配布・改変は禁止されています。
